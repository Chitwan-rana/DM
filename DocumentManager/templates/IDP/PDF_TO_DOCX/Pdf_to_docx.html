{% extends 'base.html' %}
{% load static %}

{% block title %}PDF to Word Converter{% endblock %}

{% block main %}
<div class="container py-5">
  <div class="mx-auto" style="max-width: 600px;">
    <h2 class="mb-3 text-center"><i class="bi bi-file-earmark-word-fill text-primary"></i> PDF to Word Converter</h2>
    <p class="text-muted text-center">Upload a PDF and convert it into an editable Word document.</p>

    <form id="uploadForm" class="border p-4 rounded shadow-sm bg-white" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="mb-3">
        <label for="pdf_file" class="form-label">Choose a PDF file</label>
        <input type="file" id="pdf_file" name="pdf_file" class="form-control" accept=".pdf" required />
        <div class="form-text">Only PDF files are allowed. Maximum size: 25MB.</div>
        <div class="form-text" id="fileNameDisplay" style="color: #555; display: none;"></div>
        <div id="sizeError" class="text-danger mt-1" style="display: none;"></div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button type="submit" id="uploadBtn" class="btn btn-outline-primary">
          <span id="uploadBtnText"><i class="bi bi-upload"></i> Upload PDF</span>
          <span class="spinner-border spinner-border-sm d-none" role="status" id="uploadSpinner"></span>
        </button>

        <button type="button" id="convertBtn" class="btn btn-outline-success">
          <span id="convertBtnText"><i class="bi bi-arrow-right-circle"></i> Convert to Word</span>
          <span class="spinner-border spinner-border-sm d-none" role="status" id="convertSpinner"></span>
        </button>

        <a id="downloadBtn" href="#" class="btn btn-success ms-auto d-none" download>
          <i class="bi bi-download"></i> Download Word
        </a>
      </div>

      <div id="errorMessage" class="alert alert-danger mt-3 d-none" role="alert"></div>
      <div id="successMessage" class="alert alert-success mt-3 d-none" role="alert"></div>
    </form>
  </div>
</div>

<script>
  const fileInput = document.getElementById('pdf_file');
  const fileNameDisplay = document.getElementById('fileNameDisplay');
  const uploadForm = document.getElementById('uploadForm');
  const uploadBtn = document.getElementById('uploadBtn');
  const convertBtn = document.getElementById('convertBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  const uploadSpinner = document.getElementById('uploadSpinner');
  const convertSpinner = document.getElementById('convertSpinner');
  const sizeError = document.getElementById('sizeError');

  // Maximum file size: 25MB in bytes
  const MAX_FILE_SIZE = 25 * 1024 * 1024;

  let currentPdfPath = null;

  // Show file name when user selects a file and validate size
  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    sizeError.style.display = 'none';
    uploadBtn.disabled = false;
    
    if (file) {
      fileNameDisplay.textContent = `Selected file: ${file.name}`;
      fileNameDisplay.style.display = 'block';
      
      // Check file size
      if (file.size > MAX_FILE_SIZE) {
        sizeError.textContent = `File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds the 25MB limit.`;
        sizeError.style.display = 'block';
        uploadBtn.disabled = true;
      }
    } else {
      fileNameDisplay.style.display = 'none';
    }
  });

  function showError(msg) {
    errorMessage.textContent = msg;
    errorMessage.classList.remove('d-none');
    successMessage.classList.add('d-none');
  }

  function showSuccess(msg) {
    successMessage.textContent = msg;
    successMessage.classList.remove('d-none');
    errorMessage.classList.add('d-none');
  }

  function hideMessages() {
    errorMessage.classList.add('d-none');
    successMessage.classList.add('d-none');
  }

  uploadForm.addEventListener('submit', function (e) {
    e.preventDefault();
    hideMessages();

    const file = fileInput.files[0];
    if (!file || !file.name.toLowerCase().endsWith('.pdf')) {
      showError('Please select a valid PDF file.');
      return;
    }
    
    // Double-check file size before submitting
    if (file.size > MAX_FILE_SIZE) {
      showError(`File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds the 25MB limit.`);
      return;
    }

    uploadBtn.disabled = true;
    uploadSpinner.classList.remove('d-none');

    const formData = new FormData();
    formData.append('pdf_file', file);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch('/upload/', {
      method: 'POST',
      body: formData,
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          currentPdfPath = data.pdf_path;
          showSuccess('PDF uploaded successfully!');
          downloadBtn.classList.add('d-none');
        } else {
          showError(data.error || 'Upload failed.');
        }
      })
      .catch((err) => showError(err.message || 'Upload error occurred.'))
      .finally(() => {
        uploadBtn.disabled = false;
        uploadSpinner.classList.add('d-none');
      });
  });

  convertBtn.addEventListener('click', function () {
    hideMessages();

    if (!currentPdfPath) {
      showError('Please upload a PDF first.');
      return;
    }

    convertBtn.disabled = true;
    convertSpinner.classList.remove('d-none');

    const formData = new FormData();
    formData.append('pdf_path', currentPdfPath);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    fetch('/pdf_to_docx/', {
      method: 'POST',
      body: formData,
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          downloadBtn.href = data.docx_url;
          downloadBtn.download = data.docx_filename;
          downloadBtn.classList.remove('d-none');
          showSuccess('Conversion successful! You can download the Word file.');
        } else {
          showError(data.error || 'Conversion failed.');
        }
      })
      .catch((err) => showError(err.message || 'Conversion error occurred.'))
      .finally(() => {
        convertBtn.disabled = false;
        convertSpinner.classList.add('d-none');
      });
  });
</script>
{% endblock %}
