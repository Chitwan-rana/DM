{% extends "base.html" %}
{% load static %}

{% block title %}PDF Redaction Tool{% endblock %}

{% block main %}
<style>
    .redact-wrapper {
        max-width: 600px;
        margin: 50px auto;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        padding: 30px;
    }
    .form-label {
        font-weight: 600;
    }
    .info-text {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .btn-primary {
        background-color: #1e88e5;
        border: none;
        padding: 10px 20px;
    }
    .btn-primary:hover {
        background-color: #1976d2;
    }
</style>

<div class="redact-wrapper">
    <form method="POST" enctype="multipart/form-data" id="redact-form">
        {% csrf_token %}

        <h4 class="mb-4 text-center">Redact Sensitive Info from PDF</h4>

        <div class="mb-3">
            <label class="form-label">Upload PDF</label>
            <input type="file" name="pdf" accept=".pdf" required class="form-control" id="pdf-upload">
            <small class="info-text">Only PDF files are allowed. Maximum size: 25MB.</small>
            <div id="size-error" class="text-danger mt-1" style="display: none;"></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Redaction Terms (optional)</label>
            <input type="text" name="terms" placeholder="e.g. email@example.com, 1234567890" class="form-control">
            <small class="info-text">Comma-separated keywords to redact.</small>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary" id="submit-button">
                <span id="button-text">Continue</span>
                <span id="button-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('redact-form');
        const button = document.getElementById('submit-button');
        const spinner = document.getElementById('button-spinner');
        const buttonText = document.getElementById('button-text');
        const fileInput = document.getElementById('pdf-upload');
        const sizeError = document.getElementById('size-error');
        
        // Maximum file size: 25MB in bytes
        const MAX_FILE_SIZE = 25 * 1024 * 1024;

        // Check file size when selected
        fileInput.addEventListener('change', function() {
            sizeError.style.display = 'none';
            button.disabled = false;
            
            if (this.files.length > 0) {
                const fileSize = this.files[0].size;
                if (fileSize > MAX_FILE_SIZE) {
                    sizeError.textContent = `File size (${(fileSize / (1024 * 1024)).toFixed(2)}MB) exceeds the 25MB limit.`;
                    sizeError.style.display = 'block';
                    button.disabled = true;
                }
            }
        });

        form.addEventListener('submit', function(e) {
            // Double-check file size before submitting
            if (fileInput.files.length > 0 && fileInput.files[0].size > MAX_FILE_SIZE) {
                e.preventDefault();
                sizeError.textContent = `File size exceeds the 25MB limit.`;
                sizeError.style.display = 'block';
                return false;
            }
            
            button.disabled = true;
            buttonText.classList.add('d-none');
            spinner.classList.remove('d-none');

            // fallback: reset after 30s if no response
            setTimeout(() => {
                button.disabled = false;
                spinner.classList.add('d-none');
                buttonText.classList.remove('d-none');
            }, 30000);
        });
    });
</script>
{% endblock %}
