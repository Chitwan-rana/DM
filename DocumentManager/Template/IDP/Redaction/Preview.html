{% extends "base.html" %}
{% load static %}

{% block title %}PDF Redaction Preview{% endblock %}

{% block main %}
<style>
    .preview-container {
        max-width: 1200px;
        margin: 30px auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        padding: 25px;
    }
    .pdf-page-container {
        position: relative;
        display: inline-block;
        margin: 15px;
    }
    canvas, img {
        border: 1px solid #dee2e6;
        max-width: 100%;
        height: auto;
    }
    .draw-layer {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        cursor: crosshair;
    }
    .page-indicator {
        position: absolute;
        top: 5px;
        right: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
    }
</style>

<div class="preview-container">
    <h4 class="mb-3">Preview & Confirm Redactions</h4>
    <p class="text-muted">Review the detected and drawn redactions before finalizing.</p>

    <div class="mb-3 d-flex justify-content-between flex-wrap gap-2">
        <div>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="undoBtn">
                <i class="bi bi-arrow-counterclockwise"></i> Undo Last
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" id="clearBtn">
                <i class="bi bi-trash"></i> Clear All
            </button>
        </div>
        <a href="{% url 'redact' %}" class="btn btn-link btn-sm text-decoration-none">
            <i class="bi bi-arrow-left-circle"></i> Redact Another PDF
        </a>
    </div>

    <form method="POST" action="{% url 'redact_confirm' %}" id="redact-form">
        {% csrf_token %}
        <input type="hidden" name="boxes_json" id="boxes_json">

        <div class="text-center" id="pdf-preview">
            {% for img in images %}
                <div class="pdf-page-container">
                    <span class="page-indicator">Page {{ forloop.counter }}</span>
                    <img src="{{ img }}" id="img_{{ forloop.counter0 }}" class="pdf-img" onload="setupCanvas(this)">
                    <canvas class="draw-layer" id="canvas_{{ forloop.counter0 }}" data-page="{{ forloop.counter0 }}"></canvas>
                </div>
            {% endfor %}
        </div>

        <div class="text-end mt-4">
            <button type="submit" class="btn btn-primary" id="submit-button" onclick="saveBoxes()">
                <span id="button-text"><i class="bi bi-check-circle"></i> Confirm & Redact PDF</span>
                <span id="button-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            </button>
        </div>
    </form>
</div>

<script>
    let drawings = {};

    function setupCanvas(img) {
        const index = img.id.split('_')[1];
        const canvas = document.getElementById(`canvas_${index}`);
        const rect = img.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        const page = canvas.dataset.page;
        if (!drawings[page]) drawings[page] = [];
        redrawCanvas(canvas.getContext('2d'), canvas, page);
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".draw-layer").forEach(canvas => {
            const ctx = canvas.getContext("2d");
            let startX, startY, isDrawing = false;
            const page = canvas.dataset.page;
            if (!drawings[page]) drawings[page] = [];

            canvas.addEventListener("mousedown", e => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
            });

            canvas.addEventListener("mousemove", e => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                redrawCanvas(ctx, canvas, page, startX, startY, x - startX, y - startY);
            });

            canvas.addEventListener("mouseup", e => {
                if (!isDrawing) return;
                isDrawing = false;
                const rect = canvas.getBoundingClientRect();
                const endX = e.clientX - rect.left;
                const endY = e.clientY - rect.top;

                if (Math.abs(endX - startX) > 5 && Math.abs(endY - startY) > 5) {
                    drawings[page].push({
                        x: Math.min(startX, endX),
                        y: Math.min(startY, endY),
                        w: Math.abs(endX - startX),
                        h: Math.abs(endY - startY)
                    });
                    redrawCanvas(ctx, canvas, page);
                }
            });
        });

        document.getElementById("undoBtn").addEventListener("click", () => {
            for (const page in drawings) {
                if (drawings[page].length > 0) {
                    drawings[page].pop();
                    const canvas = document.getElementById(`canvas_${page}`);
                    redrawCanvas(canvas.getContext("2d"), canvas, page);
                    break;
                }
            }
        });

        document.getElementById("clearBtn").addEventListener("click", () => {
            if (confirm("Clear all redaction boxes?")) {
                for (const page in drawings) {
                    drawings[page] = [];
                    const canvas = document.getElementById(`canvas_${page}`);
                    redrawCanvas(canvas.getContext("2d"), canvas, page);
                }
            }
        });

        // Spinner logic
        const form = document.getElementById('redact-form');
        const button = document.getElementById('submit-button');
        const spinner = document.getElementById('button-spinner');
        const buttonText = document.getElementById('button-text');

        form.addEventListener('submit', function () {
            button.disabled = true;
            buttonText.classList.add('d-none');
            spinner.classList.remove('d-none');

            // Optional auto-reset in case redirect fails
            setTimeout(() => {
                button.disabled = false;
                spinner.classList.add('d-none');
                buttonText.classList.remove('d-none');
            }, 30000);
        });
    });

    function redrawCanvas(ctx, canvas, page, previewX, previewY, previewW, previewH) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawings[page].forEach(r => {
            ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
            ctx.fillRect(r.x, r.y, r.w, r.h);
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            ctx.strokeRect(r.x, r.y, r.w, r.h);
        });
        if (previewX !== undefined) {
            ctx.fillStyle = "rgba(0, 0, 255, 0.2)";
            ctx.fillRect(previewX, previewY, previewW, previewH);
            ctx.strokeStyle = "blue";
            ctx.strokeRect(previewX, previewY, previewW, previewH);
        }
    }

    function saveBoxes() {
        document.getElementById("boxes_json").value = JSON.stringify(drawings);
    }
</script>
{% endblock %}
